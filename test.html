<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat (E2EE)</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>

    <style>
        /* Mobile-First Design Styles */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            padding: 0; 
            background-color: #e5ddd5; 
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container { 
            width: 100%; 
            max-width: 600px; /* PC पर बहुत चौड़ा नहीं होगा */
            background: white; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
        }

        header {
            background-color: #075e54;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #loginDiv, #chatDiv { 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            height: 100%;
            box-sizing: border-box;
        }

        /* चैट एरिया */
        #chatBox { 
            flex-grow: 1; 
            border: none; 
            background-color: #f0f0f0; 
            background-image: radial-gradient(#ddd 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 15px; 
            font-size: 16px; 
            line-height: 1.5;
            resize: none; 
            margin-bottom: 15px;
            border-radius: 8px;
            overflow-y: auto;
            color: #333;
        }

        /* इनपुट बॉक्स स्टाइल */
        input[type="text"] { 
            padding: 12px 15px; 
            border: 1px solid #ccc; 
            border-radius: 25px; 
            outline: none;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        input:focus { border-color: #075e54; }

        /* बटन स्टाइल */
        button { 
            padding: 12px; 
            background-color: #25d366; 
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 16px;
            width: 100%;
            transition: background 0.2s;
        }
        button:hover { background-color: #128c7e; }
        
        .small-btn { width: auto; padding: 8px 20px; margin-top: 5px; }

        .info-box {
            background-color: #dcf8c6;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
            border: 1px solid #ccebb6;
        }

        .id-text {
            font-family: monospace;
            background: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            user-select: all; /* क्लिक करते ही सेलेक्ट हो जाएगा */
            font-weight: bold;
            color: #075e54;
        }

        /* जब चैट स्क्रीन दिखे तो लॉगिन छुप जाए */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <header>Secure Chat (E2EE)</header>

    <div id="loginDiv">
        <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
            <h3 style="text-align: center; color: #444;">Welcome</h3>
            <p style="text-align: center; color: #777;">Enter your name to generate secure keys.</p>
            
            <input type="text" id="username" placeholder="Display Name (e.g. Rahul)">
            <button onclick="login()">Start Chatting</button>
        </div>
    </div>

    <div id="chatDiv" class="hidden">
        <div class="info-box">
            Your ID: <span id="myId" class="id-text">...</span>
            <br><span style="font-size: 12px; color: #555;">(Share this ID with your friend)</span>
        </div>

        <div id="connectionArea" style="margin-bottom: 10px;">
            <input type="text" id="partnerId" placeholder="Paste Friend's ID here">
            <button class="small-btn" style="background-color: #34b7f1;" onclick="connectPartner()">Connect</button>
        </div>

        <textarea id="chatBox" readonly placeholder="Waiting for connection..."></textarea>
        
        <div style="display:flex; gap: 10px;">
            <input type="text" id="messageInput" placeholder="Type a message..." style="margin-bottom:0;">
            <button class="small-btn" style="width: 80px; margin-top:0;" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. FIREBASE CONFIGURATION (यहाँ पेस्ट करें)
    // ==========================================
    const firebaseConfig = {
    apiKey: "AIzaSyAbCj12bi0okTOs_Goi-HikR7bWwtYvvBs",
    authDomain: "fast-chat-app-5b4f0.firebaseapp.com",
    projectId: "fast-chat-app-5b4f0",
    storageBucket: "fast-chat-app-5b4f0.firebasestorage.app",
    messagingSenderId: "1094615740322",
    appId: "1:1094615740322:web:6b882419efefb1dd5a8cfb"
  };
    // ==========================================

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // Variables
    let username = "";
    let myId = "";
    let partnerId = "";
    
    // Generate Keys (Curve25519)
    const keyPair = nacl.box.keyPair();
    const privateKey = keyPair.secretKey;
    const publicKey = keyPair.publicKey;

    // --- LOGIN FUNCTION ---
    function login() {
        username = document.getElementById("username").value.trim();
        if(!username) { alert("Please enter your name"); return; }
        
        // Generate random ID
        myId = "USER-" + Math.floor(Math.random()*1000000);
        document.getElementById("myId").innerText = myId;
        
        // UI Switch
        document.getElementById("loginDiv").classList.add("hidden");
        document.getElementById("chatDiv").classList.remove("hidden");

        // Upload Public Key
        db.ref("users/" + myId).set({
            username: username,
            publicKey: nacl.util.encodeBase64(publicKey)
        });

        listenMessages();
    }

    // --- CONNECT FUNCTION ---
    function connectPartner() {
        const pid = document.getElementById("partnerId").value.trim();
        if(!pid) { alert("Enter Partner ID"); return; }
        if(pid === myId) { alert("You cannot chat with yourself!"); return; }
        
        partnerId = pid;
        document.getElementById("connectionArea").style.display = "none"; // Hide connection box after connect
        document.getElementById("chatBox").placeholder = "Connected to " + partnerId + "\nStart typing...";
        alert("Connected! You can now send messages.");
    }

    // --- SEND MESSAGE (FIXED) ---
    function sendMessage() {
        if(!partnerId) { alert("Please connect to a partner ID first."); return; }
        
        const input = document.getElementById("messageInput");
        const msg = input.value;
        if(!msg) return;

        // Fetch Partner's Public Key
        db.ref("users/" + partnerId + "/publicKey").once("value").then(snapshot => {
            if (!snapshot.exists()) {
                alert("Partner ID invalid or offline.");
                return;
            }

            const partnerPubKey = nacl.util.decodeBase64(snapshot.val());
            const nonce = nacl.randomBytes(24);
            
            // Encrypt
            const encrypted = nacl.box(
                nacl.util.decodeUTF8(msg), 
                nonce, 
                partnerPubKey, 
                privateKey
            );

            // Send to DB
            const msgData = {
                sender: myId,
                senderName: username,
                message: nacl.util.encodeBase64(encrypted),
                nonce: nacl.util.encodeBase64(nonce),
                timestamp: Date.now()
            };

            db.ref("messages/" + partnerId).push(msgData);
            
            // Show my own message in chatbox
            appendMessage("Me", msg);
            input.value = "";
        });
    }

    // --- RECEIVE MESSAGES (FIXED) ---
    function listenMessages() {
        db.ref("messages/" + myId).on("child_added", snapshot => {
            const data = snapshot.val();
            
            // Fetch Sender's Public Key to Verify/Decrypt
            db.ref("users/" + data.sender + "/publicKey").once("value").then(userSnap => {
                if(!userSnap.exists()) return;

                const senderPubKey = nacl.util.decodeBase64(userSnap.val());
                const nonce = nacl.util.decodeBase64(data.nonce);
                const cipherText = nacl.util.decodeBase64(data.message);

                try {
                    const decrypted = nacl.box.open(cipherText, nonce, senderPubKey, privateKey);
                    
                    if (decrypted) {
                        const msgText = nacl.util.encodeUTF8(decrypted);
                        appendMessage(data.senderName, msgText);
                        
                        // Auto-set partner ID if not set (optional convenience)
                        if(!partnerId) {
                            partnerId = data.sender;
                            document.getElementById("partnerId").value = partnerId;
                            document.getElementById("connectionArea").style.display = "none";
                        }
                    }
                } catch(e) {
                    console.error("Decryption error:", e);
                }
            });
        });
    }

    // Helper to add text to textarea
    function appendMessage(sender, text) {
        const chatBox = document.getElementById("chatBox");
        chatBox.value += sender + ": " + text + "\n";
        chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll to bottom
    }

</script>
</body>
</html>