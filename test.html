<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fixed 1-to-1 Secure Chat</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
<style>
    /* पूरे पेज की सेटिंग */
    body { 
        font-family: 'Segoe UI', sans-serif; 
        margin: 0; 
        padding: 0; 
        background-color: #e5ddd5; /* WhatsApp जैसा बैकग्राउंड */
        display: flex;
        justify-content: center;
        height: 100vh;
    }

    /* मेन चैट कंटेनर */
    .container { 
        width: 100%; 
        max-width: 600px; /* कंप्यूटर पर ज्यादा चौड़ा नहीं होगा */
        background: white; 
        display: flex; 
        flex-direction: column;
        height: 100%; 
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 { 
        text-align: center; 
        padding: 15px; 
        margin: 0; 
        background-color: #075e54; 
        color: white; 
        font-size: 1.2rem;
    }

    /* लॉगिन और इनपुट एरिया */
    #loginDiv, #chatDiv { 
        padding: 20px; 
        display: flex; 
        flex-direction: column; 
        height: 100%;
    }

    /* चैट बॉक्स (मैसेज एरिया) */
    #chatBox { 
        flex-grow: 1; 
        border: none; 
        background-color: #f0f0f0; 
        padding: 10px; 
        font-size: 16px; 
        resize: none; 
        margin-bottom: 10px;
        border-radius: 8px;
    }

    /* इनपुट और बटन */
    .input-group { display: flex; gap: 10px; margin-top: 10px; }
    
    input[type="text"] { 
        padding: 12px; 
        border: 1px solid #ccc; 
        border-radius: 20px; 
        flex-grow: 1; 
        outline: none;
    }

    button { 
        padding: 10px 20px; 
        background-color: #25d366; 
        color: white; 
        border: none; 
        border-radius: 20px; 
        cursor: pointer; 
        font-weight: bold;
    }

    button:hover { background-color: #128c7e; }

    .info { 
        background: #e1f5fe; 
        padding: 10px; 
        border-radius: 5px; 
        font-size: 0.9em; 
        margin-bottom: 10px; 
        word-break: break-all; /* ID मोबाइल स्क्रीन से बाहर न जाए */
    }
</style>
</head>
<body>

<div class="container">
    <h2>1-to-1 Secure Chat (E2EE)</h2>

    <div id="loginDiv">
        <p>This chat uses TweetNaCl.js for client-side encryption.</p>
        <input type="text" id="username" placeholder="Enter your display name">
        <button onclick="login()">Generate Keys & Login</button>
    </div>

    <div id="chatDiv" style="display:none;">
        <div class="info">
            <strong>Your ID:</strong> <span id="myId" style="color:blue"></span><br>
            Share this ID with your friend to connect.
        </div>
        
        <div style="margin-bottom: 15px;">
            <input type="text" id="partnerId" placeholder="Paste Partner's ID here">
            <button onclick="connectPartner()">Connect</button>
        </div>

        <textarea id="chatBox" readonly></textarea><br>
        
        <div style="display:flex;">
            <input type="text" id="messageInput" placeholder="Type a secret message..." style="flex-grow:1;">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
    // -------- 1. CONFIGURATION --------
    // REPLACE THESE VALUES WITH YOUR FIREBASE CONSOLE CONFIG
    const firebaseConfig = {
    apiKey: "AIzaSyAbCj12bi0okTOs_Goi-HikR7bWwtYvvBs",
    authDomain: "fast-chat-app-5b4f0.firebaseapp.com",
    projectId: "fast-chat-app-5b4f0",
    storageBucket: "fast-chat-app-5b4f0.firebasestorage.app",
    messagingSenderId: "1094615740322",
    appId: "1:1094615740322:web:6b882419efefb1dd5a8cfb"
  };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // -------- 2. CRYPTO SETUP --------
    let username = "";
    let myId = "";
    let partnerId = "";
    
    // Generate ephemeral keys (Curve25519)
    const keyPair = nacl.box.keyPair();
    const privateKey = keyPair.secretKey;
    const publicKey = keyPair.publicKey;

    // -------- 3. FUNCTIONS --------

    function login() {
        username = document.getElementById("username").value.trim();
        if(!username) { alert("Enter name"); return; }
        
        // Create a random ID
        myId = "USER-" + Math.floor(Math.random()*1000000);
        document.getElementById("myId").innerText = myId;
        
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("chatDiv").style.display = "block";

        // Store public key in DB so others can find it
        db.ref("users/" + myId).set({
            username: username,
            publicKey: nacl.util.encodeBase64(publicKey)
        });

        // Start listening for incoming messages immediately
        listenMessages();
    }

    function connectPartner() {
        partnerId = document.getElementById("partnerId").value.trim();
        if(!partnerId) { alert("Enter partner ID"); return; }
        alert("Target set to: " + partnerId + ". You can now message them.");
    }

    function sendMessage() {
        if(!partnerId) { alert("Please connect to a partner ID first."); return; }
        
        const msgInput = document.getElementById("messageInput");
        const msg = msgInput.value;
        if(!msg) return;

        // 1. Get Partner's Public Key from Firebase
        db.ref("users/" + partnerId + "/publicKey").once("value").then(snapshot => {
            if (!snapshot.exists()) {
                alert("Partner ID not found!");
                return;
            }

            const partnerPubKeyBase64 = snapshot.val();
            const partnerPubKey = nacl.util.decodeBase64(partnerPubKeyBase64);
            
            // 2. Generate a One-Time Nonce
            const nonce = nacl.randomBytes(24);
            
            // 3. Encrypt the message
            // box(message, nonce, receiverPublicKey, senderPrivateKey)
            const encrypted = nacl.box(
                nacl.util.decodeUTF8(msg), 
                nonce, 
                partnerPubKey, 
                privateKey
            );

            // 4. Send to Firebase
            const msgData = {
                sender: myId,
                senderName: username,
                message: nacl.util.encodeBase64(encrypted),
                nonce: nacl.util.encodeBase64(nonce),
                timestamp: Date.now()
            };

            db.ref("messages/" + partnerId).push(msgData);
            
            // UI Update: Show my own message
            const chatBox = document.getElementById("chatBox");
            chatBox.value += "Me: " + msg + "\n";
            chatBox.scrollTop = chatBox.scrollHeight;
            msgInput.value = "";
        });
    }

    function listenMessages() {
        // Listen to node: messages/MY_ID
        db.ref("messages/" + myId).on("child_added", snapshot => {
            const data = snapshot.val();
            
            // FIX: We must fetch the SENDER'S public key to decrypt
            db.ref("users/" + data.sender + "/publicKey").once("value").then(userSnap => {
                if(!userSnap.exists()) {
                    console.error("Unknown sender");
                    return;
                }

                const senderPubKey = nacl.util.decodeBase64(userSnap.val());
                const nonce = nacl.util.decodeBase64(data.nonce);
                const messageHelper = nacl.util.decodeBase64(data.message);

                try {
                    // Decrypt: box.open(cipher, nonce, senderPublicKey, receiverPrivateKey)
                    const decrypted = nacl.box.open(
                        messageHelper,
                        nonce,
                        senderPubKey,
                        privateKey
                    );

                    if (decrypted) {
                        const msgText = nacl.util.encodeUTF8(decrypted);
                        const chatBox = document.getElementById("chatBox");
                        chatBox.value += (data.senderName || "Partner") + ": " + msgText + "\n";
                        chatBox.scrollTop = chatBox.scrollHeight;
                    } else {
                        console.error("Decryption failed - signature mismatch or wrong key");
                    }
                } catch(e) {
                    console.error("Error decrypting:", e);
                }
            });
        });
    }
</script>
</body>
</html>